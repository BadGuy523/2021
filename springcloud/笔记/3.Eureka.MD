### 简介
- Spring-Cloud Euraka是Spring Cloud集合中一个组件，它是对Euraka的集成，用于服务注册和发现。Eureka是Netflix中的一个开源框架。它和 zookeeper、Consul一样，都是用于服务注册管理的
### 引入原因
- 在没有服务注册中心前，只能在客户端配置文件中维护服务提供者的列表，会有如下问题：
  1. 服务上线下线动态感知问题
  2. 服务调用者的维护工作比较困难
### 工作机制
- 服务端与客户端的服务都会在服务注册中心注册
- 服务注册中心会与注册的服务进行心跳检测，会定时剔除无效服务，添加新增服务的注册信息
- 服务调用者如何感知服务的上下线
  1. 服务注册中心push，主动推送
  2. 服务调用者pull，定时轮询拉取更新
  3. 服务调用者进行监听回调
  4. long-pull,长连接
### 常见服务注册中心
- Eureka：非持久化存储、ap(模型)、集群节点的角色相等
- Consul：raft （redis-sentinel/nacos选举）  long polling
- Zookeeper：zab协议(paxos) push
- Etcd：raft long polling
- Nacos：raft long polling
- Redis
### CAP
- C 一致性 (consistency 强一致性)
- A 可用性
- P 分区容错性（集群节点/跨区域的高可用）
- CP:强一致性；AP:高可用性
### Eureka源码分析核心功能
##### 自我保护机制
- Eureka心跳失败的比例 在15分钟内，低于85%的节点，Eureka server会认为这个实例出现了网络故障，直接剔除这个有问题的服务
- 自我保护机制会减少网络抖动或者网络不稳定的情况下，避免误删除。那么这个服务不会被剔除
  1. Eureka Server不会剔除因为长时间没有收到心跳数据的过期服务
  2. Eureka Server仍然能够接收新的服务的注册和发现
- AbstractInstanceRegistry抽象类
```
protected volatile int numberOfRenewsPerMinThreshold; //每一分钟最小的续约数量
protected volatile int expectedNumberOfClientsSendingRenews; // 预期每分钟收到的续约的客户端数量

// 更新每分钟最小续约的阈值：预期每分钟收到的续约客户端数量 * （60 / 客户端续约时间间隔） * 阈值百分比（默认0.85）
protected void updateRenewsPerMinThreshold() {
    this.numberOfRenewsPerMinThreshold = (int) (this.expectedNumberOfClientsSendingRenews
            * (60.0 / serverConfig.getExpectedClientRenewalIntervalSeconds())
            * serverConfig.getRenewalPercentThreshold());
}
```
- expectedNumberOfClientsSendingRenews（预期每分钟续约的客户端数量如何动态计数）：AbstractInstanceRegistry抽象类
```
// 服务上线(register方法)
synchronized (lock) {
    if (this.expectedNumberOfClientsSendingRenews > 0) {
        // Since the client wants to register it, increase the number of clients sending renews
        this.expectedNumberOfClientsSendingRenews = this.expectedNumberOfClientsSendingRenews + 1; 
        updateRenewsPerMinThreshold();
    }
}

// 服务下线(cancle)
synchronized (lock) {
    if (this.expectedNumberOfClientsSendingRenews > 0) {
        // Since the client wants to cancel it, reduce the number of clients to send renews.
        this.expectedNumberOfClientsSendingRenews = this.expectedNumberOfClientsSendingRenews - 1;
        updateRenewsPerMinThreshold();
    }
}

// 定时任务(PeerAwareInstanceRegistryImpl实现类)
@Override
public void init(PeerEurekaNodes peerEurekaNodes) throws Exception {
    this.numberOfReplicationsLastMin.start();
    this.peerEurekaNodes = peerEurekaNodes;
    initializedResponseCache();
    scheduleRenewalThresholdUpdateTask(); // 定时任务
    initRemoteRegionRegistry();

    try {
        Monitors.registerObject(this);
    } catch (Throwable e) {
        logger.warn("Cannot register the JMX monitor for the InstanceRegistry :", e);
    }
}
在DefaultEurekaServerContext类中调用
@PostConstruct ？？
@Override
public void initialize() {
    logger.info("Initializing ...");
    peerEurekaNodes.start();
    try {
        registry.init(peerEurekaNodes);
    } catch (Exception e) {
        throw new RuntimeException(e);
    }
    logger.info("Initialized");
}
// 何时判断(PeerAwareInstanceRegistryImpl实现类)
@Override
public boolean isLeaseExpirationEnabled() {
    if (!isSelfPreservationModeEnabled()) {
        // The self preservation mode is disabled, hence allowing the instances to expire.
        return true;
    }
    return numberOfRenewsPerMinThreshold > 0 && getNumOfRenewsInLastMin() > numberOfRenewsPerMinThreshold;
}
```
##### Eureka Server如何接受请求
- ApplicationsResource类和ApplicationResource类
- 使用了Jersey RESTful WebService框架
##### 服务的注册
- 服务启动后进行注册，SmartLifeCycle：Spring容器加载完所有的Bean并且初始化完成后会调用start方法
##### 服务的查询/发现
##### 服务的续约
##### 三级缓存
