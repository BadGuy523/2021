### 简介
- Hystrix是Netflix开源的一款容错框架，具有自我保护能力
### 熔断降级
- 熔断的目的是为了起到保护作用，避免发生雪崩效应
- 降级（熔断是一种降级策略）
  1. 主动降级，主动关闭一些非核心服务
  2. 被动降级，熔断降级、限流降级
### Hystrix的作用
- 对来自依赖的延迟和故障进行防护和控制——这些依赖通常都是通过网络访问的
- 阻止故障的连锁反应
- 快速失败并迅速恢复
- 回退并优雅降级
- 提供近实时的监控与告警
### Hystrix的三种降级方案（fallback->回退方案/降级处理方案）
##### 熔断触发降级
```
/**
 * 熔断触发降级测试（所有参数都在HystrixCommandProperties类中）
 * 如何触发熔断：10s之内，发起了5次请求，失败率超过50%；熔断时间5s恢复之前，请求都不会到达服务端
 *
 * @return
 */
@HystrixCommand(commandProperties = {
        @HystrixProperty(name = "circuitBreaker.enabled",value = "true"), // 断路器是否开启
        @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold",value = "5"), // 最小请求次数
        @HystrixProperty(name = "circuitBreaker.sleepWindowInMilliseconds",value = "5000"), // 熔断的时间，该时间过后会恢复
        @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage",value = "50") // 失败请求百分比
    },fallbackMethod = "fallback")
@GetMapping("/test/{num}")
public String test(@PathVariable Integer num) {
    if (num == 1) {
        return "success";
    }
    return restTemplate.getForEntity("http://localhost:8080/test",String.class).getBody();
}

public String fallback(Integer num) {
    return "系统繁忙";
}
```
##### 请求超时触发降级
```
/**
 * 请求超时触发降级测试（所有参数都在HystrixCommandProperties类中）
 *
 * @return
 */
@HystrixCommand(commandProperties = {
        @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds",value = "3000") // 设置超时时间
    },fallbackMethod = "timeoutFallback")
@GetMapping("/test2/{num}")
public String test2(@PathVariable Integer num) {
    if (num == 1) {
        return "success";
    }
    return restTemplate.getForEntity("http://localhost:8080/test",String.class).getBody();
}

public String timeoutFallback(Integer num) {
    return "请求超时";
}
```
##### 资源隔离触发降级
- 平台隔离、部署隔离、业务隔离、服务隔离、资源隔离
- 资源隔离：CPU、内存、线程
###### 信号量隔离
```
/**
  * 信号量隔离实现
  * 不会使用Hystrix管理的线程池处理请求。使用容器（Tomcat）的线程处理请求逻辑。
  * 不涉及线程切换，资源调度，上下文的转换等，相对效率高。
  * 信号量隔离也会启动熔断机制。如果请求并发数超标，则触发熔断，返回fallback数据。
  * commandProperties - 命令配置，HystrixPropertiesManager中的常量或字符串来配置。
  *   execution.isolation.strategy - 隔离的种类，可选值只有THREAD（线程池隔离）和SEMAPHORE（信号量隔离）。
  *   默认是THREAD线程池隔离。
  *   设置信号量隔离后，线程池相关配置失效。
  * execution.isolation.semaphore.maxConcurrentRequests - 信号量最大并发数。默认值是10。常见配置500~1000。
  *   如果并发请求超过配置，其他请求进入fallback逻辑。
  */
@HystrixCommand(fallbackMethod="semaphoreQuarantineFallback",
        commandProperties={
          @HystrixProperty(name=HystrixPropertiesManager.EXECUTION_ISOLATION_STRATEGY,value="SEMAPHORE"), // 信号量隔离
          @HystrixProperty(name=HystrixPropertiesManager.EXECUTION_ISOLATION_SEMAPHORE_MAX_CONCURRENT_REQUESTS,value="100") // 信号量最大并发数
```
###### 线程池隔离
```
@HystrixCommand(groupKey="order-service",
      commandKey = "queryOrder",
      threadPoolKey="order-service", //相同key使用同一线程池
      threadPoolProperties = {
          @HystrixProperty(name = "coreSize", value = "30"),//线程池大小
          @HystrixProperty(name = "maxQueueSize", value = "100"),//最大队列长度
          @HystrixProperty(name =  "keepAliveTimeMinutes", value ="2"),//线程存活时间
          @HystrixProperty(name = "queueSizeRejectionThreshold", value = "15")//拒绝请求
     },fallbackMethod = "fallback")
```
### Hystrix核心原理
##### 针对类级别的配置（自定义）
- 可配置化的降级策略
  1. 信号量/线程/超时（1s）/熔断（错误率）
  2. HystrixCommandProperty
- 可以识别的降级边界
  1. @HystrixCommand(Spring AOP)
  2. HystrixCommand抽象类
- 数据采集
  1. 如何触发熔断（10s/20个请求/错误率） -> 如何采集数据，如何统计数据
  2. SEMAPHORE，最大并发数 -> AQS -> tryAcquire(),acquire()
- 行为干预：触发降级/熔断之后，对正常业务产生影响
- 结果干预：fallback()
- 自动恢复（处于熔断状态下，会每隔5s尝试取恢复）
##### Hystrix如何让工作
- 带超时降级的Hystrix注解。
##### Hystrix的熔断原理及调用原理
