## RabbitMQ进阶
### 案例-订单延时关闭
- 超过30分钟的未付款的订单自动关闭
- 思路：发送一条订单相关信息，30分钟后被消费，消费者查询是否付款，决定是否关闭
- rabbitMQ本身不支持消息延迟投递
- 方案1：存储到数据库，定时扫描（数据大时服务器压力过大）
- 方案2：利用RabbitMQ的死信队列（Dead Letter Queue）
###### 队列属性
- x-message-ttl:消息过期属性，所有队列中的消失超过时间未被消费，都会过期
###### 消息属性
- 在发送消息时通过MessageProperties指定消息属性
###### 死信
- 消息过期后没有任何配置，是会被直接丢弃的
- 可以通过配置让过期的消息编成死信
- 队列创建的时候可以指定一个死信交换机DLX（dead letter exchange），死信交换机绑定的队列称为死信队列DLQ（dead letter queue），其实就是普通的队列和普通的交换机，替补
- 如果消息过期了，队列指定了DLX，就会发送到DLX，如果DLX绑定了DLQ，路由到DLQ，消费者就可以绑定DLQ进行消费
###### 延时队列的其他实现
- 使用死信队列实现延时消息的缺点
1. 如果设置整个队列的TTL，当不同消息过期时间梯度很多的情况，需要创建很多的死信交换机和队列来路由消息
2. 如果单独设置消息的TTL，不同消息过期时间不一样时，可能会造成队列的中的消息阻塞，比如前一条TTL为30min，后一条TTL为10min，当第二条该投递时，第一条未出队，则被阻塞
3. 路由路径边长，可能存在一定的时间误差
- RabbitMQ3.5.7及以后的版本提供了一个插件：rabbitmq-delayed-message-exchange来实现延时队列功能（插件依赖erlang/opt 18.0及以上）
- 下载地址：https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases
- 放入rabbitmq的plugins目录下
- 启用插件与停止插件
```
rabbitmq-plugins enable rabbitmq_delayed_message_exchange
rabbitmq-plugins disable rabbitmq_delayed_message_exchange
```
- 通过声明一个x-delayed-message类型的交换机来使用消息延时特性，该类型是插件提供的类型
- 生产者发送消息时指定x-delay参数
###### 除了消息过期，还有什么情况会变成死信
- 消息被消费者拒绝并且未设置重回队列：(NACK || Reject) && requeue == false
- 队列达到最大长度，超过了Max length(消息数)或者Max length bytes(字节数),最先入队的消息会被发送到DLX
### 服务端流控制（Flow Control）

