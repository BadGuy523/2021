### Apache Dubbo简介
- 是一款微服务开发框架，提供了RPC通信与微服务治理两大关键能力。这意味着，使用 Dubbo 开发的微服务，将具备相互之间的远程发现与通信能力， 同时利用 Dubbo 提供的丰富服务治理能力，可以实现诸如服务发现、负载均衡、流量调度等服务治理诉求。同时 Dubbo 是高度可扩展的，用户几乎可以在任意功能点去定制自己的实现，以改变框架的默认行为来满足自己的业务需求。
### 功能点
- 服务治理框架
- 服务的监控
- 服务的注册与发现
- 服务的通信
- 服务的容错
- 服务的负载均衡
### SpringCloud Alibaba
- Dubbo
- seata(分布式事务框架)
- rocketMQ
- Nacos
- Sentinel（熔断降级框架）
### Dubbo支持的注册中心
- consul
- zookeeper
- eureka
- redis
- etcd
- nacos
### Dubbo Spring Cloud
##### 服务提供者
- pom文件
```
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-dubbo</artifactId>
</dependency>

<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
// 面向该接口模块开发，消费者和提供者都依赖此模块
<dependency>
    <groupId>org.example</groupId>
    <artifactId>spring-cloud-dubbo-demo-api</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```
- yml文件
```
spring:
  application:
    name: spring-cloud-dubbo-demo-provider
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.160.130:8848

# dubbo.registry : Dubbo 服务注册中心配置，其中子属性 address 的值 "spring-cloud://localhost"，说明挂载到 Spring Cloud 注册中心
dubbo:
  scan:
    base-packages: com.demo.springcloud.dubbo.provider.service # dubbo服务扫描基础包路径
  protocol:
    id: dubbo #dubbo服务暴露的协议配置
    name: dubbo #协议名称
    port: 20882 #协议端口，-1表示自增端口，从20880开始
```
- 启动类
```
//@DubboComponentScan(basePackages = "com.demo.springcloud.dubbo.provider.service") //TODO 报错
@EnableDiscoveryClient // 可加可不加，默认开启
@SpringBootApplication
public class ProviderRunner {
    public static void main(String[] args) {
        SpringApplication.run(ProviderRunner.class,args);
    }
}
```
- 接口实现
```
@Service //为dubbo包下的注解
public class SayHelloServiceImpl implements ISayHelloService {
    @Override
    public String sayHello(String msg) {
        return "Yo!Hello " + msg;
    }
}
```
##### 服务消费者
- pom文件
```
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-dubbo</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>

<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>

<dependency>
    <groupId>org.example</groupId>
    <artifactId>spring-cloud-dubbo-demo-api</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```
- yml文件
```
spring:
  application:
    name: spring-cloud-dubbo-demo-consumer
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.160.130:8848

# 默认值是*，订阅所有应用（不推荐），多个由,分割
#dubbo:
#  cloud:
#    subscribed-services: spring-cloud-dubbo-demo-provider
```
- 启动类
```
@SpringBootApplication
public class ConsumerRunner {
    public static void main(String[] args) {
        SpringApplication.run(ConsumerRunner.class,args);
    }
}
```
- 服务调用
```
@RestController
public class SayHelloController {

    @Reference
    private ISayHelloService iSayHelloService;

    @GetMapping("/say")
    public String say() {
        return iSayHelloService.sayHello("man");
    }

}
```
### Dubbo Spring Boot
- dubbo集成到springboot的优势是可以继承springboot本身的特性
  1. 自动装配（注解驱动、自动装配）
  2. production-ready（安全机制、健康监测、外部化配置）
##### 服务提供者
- 从2.7开始，dubbo的版本和dubbo-spring-boot的版本是保持一致的
- pom文件
```
<dependency>
    <groupId>org.apache.dubbo</groupId>
    <artifactId>dubbo-spring-boot-starter</artifactId>
</dependency>

<dependency>
    <groupId>com.alibaba.nacos</groupId>
    <artifactId>nacos-client</artifactId>
</dependency>

<dependency>
    <groupId>org.apache.dubbo</groupId>
    <artifactId>dubbo-dependencies-zookeeper</artifactId>
</dependency>

<dependency>
    <groupId>org.example</groupId>
    <artifactId>spring-boot-dubbo-demo-api</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```
- yml文件
```
spring:
  application:
    name: spring-boot-dubbo-demo-provider
dubbo:
  scan:
    base-packages: com.demo.springboot.dubbo.provider.service
  protocol:
    name: dubbo
    port: -1 #自动指定端口
  registries:
    shanghai:
      address: zookeeper://192.168.160.130:2181
      timeout: 10000
      default: true #若@DubboService没有指定需要注册的注册中心，则按默认配置来注册
    hunan:
      address: nacos://192.168.160.130:8848
```
- 启动类
```
//@DubboComponentScan(basePackages = "com.demo.springboot.dubbo.provider.service") // 可行
@SpringBootApplication
public class ProviderRunner {
    public static void main(String[] args) {
        SpringApplication.run(ProviderRunner.class,args);
    }
}
```
- 接口实现
```
// 指定要注册的服务注册中心及版本号
@DubboService(registry = {"shanghai","hunan"},version = "1.0")
public class SayHelloServiceImpl implements ISayHelloService {
    @Override
    public String sayHello(String msg) {
        return "[v1.0]Yo!Hello " + msg;
    }
}

@DubboService(registry = {"shanghai","hunan"},version = "2.0")
public class SayHelloServiceV2Impl implements ISayHelloService {
    @Override
    public String sayHello(String msg) {
        return "[v2.0]Yo!Hello " + msg;
    }
}
```
##### 服务消费者
- pom文件
```
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>

<dependency>
    <groupId>org.apache.dubbo</groupId>
    <artifactId>dubbo-spring-boot-starter</artifactId>
</dependency>

<dependency>
    <groupId>com.alibaba.nacos</groupId>
    <artifactId>nacos-client</artifactId>
</dependency>

<dependency>
    <groupId>org.apache.dubbo</groupId>
    <artifactId>dubbo-dependencies-zookeeper</artifactId>
</dependency>

<dependency>
    <groupId>org.example</groupId>
    <artifactId>spring-boot-dubbo-demo-api</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```
- yml文件
```
spring:
  application:
    name: spring-boot-dubbo-demo-consumer

# 多服务注册中心，配置调用时的负载均衡策略
dubbo:
  registries:
    shanghai:
      address: zookeeper://192.168.160.130:2181
      timeout: 10000
      zone: shanghai  #区域优先
      weight: 100 #权重
    hunan:
      address: nacos://192.168.160.130:8848
      weight: 10
      preferred: true # 优先选择
```
- 启动类
```
@SpringBootApplication
public class ConsumerRunner {
    public static void main(String[] args) {
        SpringApplication.run(ConsumerRunner.class,args);
    }
}
```
- 服务调用
@RestController
public class SayHelloController {

    // 指定调用的服务注册中心和版本号，多服务注册中心会采取相应的负载均衡策略
    @DubboReference(registry = {"shanghai","hunan"},version = "2.0")
    private ISayHelloService iSayHelloService;

    @GetMapping("/say")
    public String say() {
        return iSayHelloService.sayHello("man");
    }

}
```
